#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Claude Flow coordination hooks
echo "🔄 Starting pre-commit quality validation..."
npx claude-flow@alpha hooks pre-task --description "Pre-commit quality validation"

# Run lint-staged for staged files
npx lint-staged

# Quality gates for pre-commit
echo "🎯 Running pre-commit quality gates..."

# Quick complexity check on staged JS files
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' | tr '\n' ' ')

if [ ! -z "$STAGED_JS_FILES" ]; then
  echo "📊 Analyzing complexity of staged files..."
  
  # Check if complexity analyzer exists and is executable
  if [ -f "scripts/quality/complexity-analyzer.js" ]; then
    # Run quick complexity check with lower threshold for pre-commit
    node scripts/quality/complexity-analyzer.js --threshold 20 --pattern "$STAGED_JS_FILES" || {
      echo "❌ Complexity check failed. Files have high complexity."
      echo "💡 Consider refactoring before committing."
      npx claude-flow@alpha hooks notify --message "Pre-commit blocked: High complexity detected"
      exit 1
    }
  fi
  
  echo "✅ Complexity check passed"
fi

# Post coordination hook
npx claude-flow@alpha hooks post-task --task-id "pre-commit-validation"
npx claude-flow@alpha hooks notify --message "Pre-commit validation completed successfully"

echo "✅ Pre-commit quality validation completed"