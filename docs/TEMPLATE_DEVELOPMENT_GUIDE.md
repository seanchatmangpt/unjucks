# Template Development and Contribution Guide

## Table of Contents
1. [Introduction](#introduction)
2. [Template Structure](#template-structure)
3. [Development Setup](#development-setup)
4. [Creating Templates](#creating-templates)
5. [Template Syntax](#template-syntax)
6. [Advanced Features](#advanced-features)
7. [Testing Templates](#testing-templates)
8. [Contribution Guidelines](#contribution-guidelines)
9. [Best Practices](#best-practices)
10. [Examples](#examples)

## Introduction

This guide provides comprehensive information for creating, testing, and contributing templates to the Unjucks ecosystem. Templates are the core building blocks that enable code generation and scaffolding.

### Template Philosophy
- **Convention over Configuration**: Follow established patterns
- **Composability**: Templates should work together seamlessly  
- **Flexibility**: Support various use cases and customizations
- **Quality**: Maintain high standards for generated code

## Template Structure

### Basic Template Organization
```
_templates/
├── generator-name/              # Generator directory
│   ├── README.md               # Generator documentation
│   ├── template-name/          # Template directory
│   │   ├── index.js           # Template configuration
│   │   ├── prompt.js          # Interactive prompts (optional)
│   │   ├── template.ejs.t     # Main template file
│   │   ├── additional.ejs.t   # Additional template files
│   │   └── README.md          # Template documentation
│   └── another-template/      # Another template
└── another-generator/          # Another generator
```

### File Naming Conventions
- **Template Files**: End with `.ejs.t` (EJS template)
- **Configuration**: `index.js` for main configuration
- **Prompts**: `prompt.js` for interactive prompts
- **Documentation**: `README.md` for each generator/template

### Template Metadata
Templates use frontmatter to define generation behavior:

```ejs
---
to: <%= output_path %>/<%= Name %>.js
condition: <%= include_component %>
inject: true
---
Template content goes here...
```

## Development Setup

### Prerequisites
- Node.js ≥18.0.0
- Unjucks CLI installed globally or locally
- Text editor with EJS syntax support

### Initial Setup
```bash
# Clone template repository or create new project
git clone https://github.com/unjucks/templates.git
cd templates

# Install dependencies
npm install

# Link for development
npm link

# Verify setup
unjucks list
```

### Development Environment
```bash
# Create development template directory
mkdir -p _templates/my-generator/my-template

# Initialize template
unjucks init --generator my-generator

# Test template
unjucks preview my-generator my-template TestName
```

## Creating Templates

### Step 1: Plan Your Template
Before creating templates, consider:
- **Purpose**: What code/files will be generated?
- **Variables**: What inputs are needed?
- **Structure**: How many files will be created?
- **Audience**: Who will use this template?

### Step 2: Create Generator Directory
```bash
mkdir -p _templates/my-generator
cd _templates/my-generator
```

### Step 3: Create Template Configuration
**`index.js`**
```javascript
module.exports = {
  // Template metadata
  description: 'Generate React component with hooks',
  
  // Prompts for interactive generation
  prompts: [
    {
      type: 'input',
      name: 'name',
      message: 'Component name?',
      validate: (input) => input.length > 0 || 'Name is required'
    },
    {
      type: 'select',
      name: 'hooks',
      message: 'Include React hooks?',
      choices: [
        { name: 'useState', value: 'useState' },
        { name: 'useEffect', value: 'useEffect' },
        { name: 'useContext', value: 'useContext' },
        { name: 'Custom hooks', value: 'custom' }
      ],
      multiple: true
    },
    {
      type: 'confirm',
      name: 'includeTests',
      message: 'Include test files?',
      default: true
    }
  ],
  
  // Post-generation hooks
  hooks: {
    after: (context) => {
      console.log(`Generated ${context.name} component successfully!`);
    }
  }
};
```

### Step 4: Create Template Files
**`component.ejs.t`**
```ejs
---
to: src/components/<%= Name %>/<%= Name %>.jsx
---
import React<% if (hooks.includes('useState')) { %>, { useState }<% } %><% if (hooks.includes('useEffect')) { %>, { useEffect }<% } %> from 'react';
<% if (includeStyles) { -%>
import styles from './<%= Name %>.module.css';
<% } -%>

/**
 * <%= Name %> component
 * Generated by Unjucks template
 */
const <%= Name %> = ({ 
<% if (props && props.length > 0) { -%>
  <% props.forEach((prop, index) => { -%>
  <%= prop.name %><%= index < props.length - 1 ? ',' : '' %>
  <% }); -%>
<% } -%>
}) => {
<% if (hooks.includes('useState')) { -%>
  const [state, setState] = useState(null);
<% } -%>
<% if (hooks.includes('useEffect')) { -%>
  
  useEffect(() => {
    // Effect logic here
  }, []);
<% } -%>

  return (
    <div<% if (includeStyles) { %> className={styles.<%= name %>}<% } %>>
      <h1><%= Name %></h1>
      {/* Component content */}
    </div>
  );
};

export default <%= Name %>;
```

**`test.ejs.t`** (conditional)
```ejs
---
to: <%= includeTests ? `src/components/${Name}/${Name}.test.jsx` : null %>
---
<% if (includeTests) { -%>
import React from 'react';
import { render, screen } from '@testing-library/react';
import <%= Name %> from './<%= Name %>';

describe('<%= Name %>', () => {
  test('renders without crashing', () => {
    render(<<%= Name %> />);
    expect(screen.getByText('<%= Name %>')).toBeInTheDocument();
  });
  
  <% if (hooks.includes('useState')) { -%>
  test('handles state updates', () => {
    // State testing logic
  });
  <% } -%>
  
  <% if (props && props.length > 0) { -%>
  test('handles props correctly', () => {
    const testProps = {
      <% props.forEach((prop, index) => { -%>
      <%= prop.name %>: <%= prop.testValue || `'test-${prop.name}'` %><%= index < props.length - 1 ? ',' : '' %>
      <% }); -%>
    };
    
    render(<<%= Name %> {...testProps} />);
    // Prop testing logic
  });
  <% } -%>
});
<% } -%>
```

### Step 5: Add Documentation
**`README.md`**
```markdown
# My Generator

Description of what this generator creates and when to use it.

## Templates

### my-template
Creates a React component with optional hooks and testing.

#### Usage
```bash
unjucks my-generator my-template ComponentName
```

#### Options
- `--hooks`: Include React hooks (useState, useEffect, etc.)
- `--includeTests`: Generate test files
- `--includeStyles`: Include CSS module

#### Generated Files
- `src/components/ComponentName/ComponentName.jsx`
- `src/components/ComponentName/ComponentName.test.jsx` (optional)
- `src/components/ComponentName/ComponentName.module.css` (optional)
```

## Template Syntax

### EJS Templating
Unjucks uses EJS (Embedded JavaScript) for template processing.

#### Variables
```ejs
<%= variable %>          <!-- Escaped output -->
<%- variable %>          <!-- Unescaped output -->
<% /* comment */ %>      <!-- Comment -->
```

#### Conditionals
```ejs
<% if (condition) { %>
  Content when true
<% } else { %>
  Content when false
<% } %>

<% if (type === 'functional') { -%>
  Functional component code
<% } else if (type === 'class') { -%>
  Class component code
<% } -%>
```

#### Loops
```ejs
<% for (let i = 0; i < items.length; i++) { %>
  Item <%= i %>: <%= items[i] %>
<% } %>

<% items.forEach(item => { %>
  - <%= item.name %>
<% }); %>
```

#### Includes
```ejs
<%- include('partials/header', { title: 'My Page' }) %>
```

### Built-in Variables

#### Case Helpers
```ejs
<%= name %>           <!-- original: myComponent -->
<%= Name %>           <!-- PascalCase: MyComponent -->
<%= NAME %>           <!-- UPPER_CASE: MY_COMPONENT -->
<%= name_snake %>     <!-- snake_case: my_component -->
<%= name_kebab %>     <!-- kebab-case: my-component -->
<%= name_camel %>     <!-- camelCase: myComponent -->
```

#### Path Variables
```ejs
<%= cwd %>            <!-- Current working directory -->
<%= output_path %>    <!-- Output directory -->
<%= template_path %>  <!-- Template source path -->
<%= relative_path %>  <!-- Relative path from cwd -->
```

#### Date/Time Variables
```ejs
<%= date %>           <!-- Current date: 2024-01-01 -->
<%= time %>           <!-- Current time: 14:30:00 -->
<%= timestamp %>      <!-- Unix timestamp -->
<%= iso_date %>       <!-- ISO date: 2024-01-01T14:30:00Z -->
<%= year %>           <!-- Current year: 2024 -->
```

#### Project Variables
```ejs
<%= project_name %>   <!-- From package.json name -->
<%= author %>         <!-- From package.json author -->
<%= version %>        <!-- From package.json version -->
<%= description %>    <!-- From package.json description -->
```

### Custom Helpers
Add custom helpers in template configuration:

```javascript
module.exports = {
  helpers: {
    titleCase: (str) => str.replace(/\w\S*/g, (txt) => 
      txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
    ),
    
    pluralize: (word, count) => count === 1 ? word : word + 's',
    
    formatDate: (date, format = 'YYYY-MM-DD') => {
      // Date formatting logic
      return formattedDate;
    }
  }
};
```

Usage in templates:
```ejs
<%= titleCase(name) %>
<%= pluralize('item', items.length) %>
<%= formatDate(new Date()) %>
```

## Advanced Features

### Conditional File Generation
Generate files based on conditions:

```ejs
---
to: <%= includeConfig ? 'config/database.js' : null %>
condition: <%= includeDatabase %>
---
<% if (includeConfig && includeDatabase) { -%>
module.exports = {
  // Database configuration
};
<% } -%>
```

### File Injection
Inject content into existing files:

```ejs
---
to: src/routes/index.js
inject: true
pattern: // ROUTES
---
app.use('/<%= name %>', require('./<%= name %>'));
```

### Multi-file Generation
Generate multiple files from single template:

```javascript
// index.js
module.exports = [
  {
    type: 'add',
    path: 'src/{{name}}/index.js',
    templateFile: 'templates/index.ejs'
  },
  {
    type: 'add',
    path: 'src/{{name}}/{{name}}.js',
    templateFile: 'templates/component.ejs'
  },
  {
    type: 'add',
    path: 'src/{{name}}/{{name}}.test.js',
    templateFile: 'templates/test.ejs',
    condition: '{{includeTests}}'
  }
];
```

### Template Inheritance
Create base templates and extend them:

**`base/component.ejs`**
```ejs
<% block('imports') %>
import React from 'react';
<% endblock() %>

<% block('component') %>
const <%= Name %> = () => {
  <% block('content') %>
  return <div><%= Name %></div>;
  <% endblock() %>
};
<% endblock() %>

<% block('export') %>
export default <%= Name %>;
<% endblock() %>
```

**`react/functional.ejs`**
```ejs
<% extend('base/component.ejs') %>

<% block('imports') %>
<% parent() %>
import { useState, useEffect } from 'react';
<% endblock() %>

<% block('content') %>
const [state, setState] = useState(null);

useEffect(() => {
  // Effect logic
}, []);

return (
  <div className="<%= name %>">
    <h1><%= Name %></h1>
  </div>
);
<% endblock() %>
```

### Dynamic Prompts
Create dynamic prompts based on previous answers:

```javascript
module.exports = {
  prompts: [
    {
      type: 'select',
      name: 'framework',
      message: 'Choose framework:',
      choices: ['react', 'vue', 'angular']
    },
    {
      type: 'select',
      name: 'reactVersion',
      message: 'React version:',
      choices: ['16', '17', '18'],
      when: (answers) => answers.framework === 'react'
    },
    {
      type: 'multiselect',
      name: 'features',
      message: 'Select features:',
      choices: (answers) => {
        const base = ['routing', 'state-management'];
        if (answers.framework === 'react') {
          return [...base, 'hooks', 'context'];
        }
        return base;
      }
    }
  ]
};
```

## Testing Templates

### Manual Testing
```bash
# Preview template output
unjucks preview generator template TestName

# Generate with dry run
unjucks generate generator template TestName --dry-run

# Generate test output
unjucks generate generator template TestName --output ./test-output
```

### Automated Testing
Create test suite for templates:

**`tests/template.test.js`**
```javascript
import { describe, test, expect } from 'vitest';
import { Unjucks } from '@seanchatmangpt/unjucks';
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

describe('Component Template', () => {
  const unjucks = new Unjucks({
    templates: ['_templates']
  });
  
  test('generates functional component', async () => {
    const result = await unjucks.generate({
      generator: 'component',
      template: 'react',
      name: 'TestComponent',
      variables: {
        type: 'functional',
        includeTests: true
      },
      output: './test-output',
      dryRun: true
    });
    
    expect(result.success).toBe(true);
    expect(result.files).toContain('src/components/TestComponent/TestComponent.jsx');
    expect(result.files).toContain('src/components/TestComponent/TestComponent.test.jsx');
  });
  
  test('generates class component', async () => {
    const result = await unjucks.generate({
      generator: 'component',
      template: 'react', 
      name: 'TestComponent',
      variables: {
        type: 'class',
        includeTests: false
      },
      output: './test-output',
      dryRun: true
    });
    
    expect(result.success).toBe(true);
    expect(result.files).toContain('src/components/TestComponent/TestComponent.jsx');
    expect(result.files).not.toContain('src/components/TestComponent/TestComponent.test.jsx');
  });
  
  test('validates generated code syntax', async () => {
    await unjucks.generate({
      generator: 'component',
      template: 'react',
      name: 'SyntaxTest',
      variables: { type: 'functional' },
      output: './test-output'
    });
    
    const componentPath = join('./test-output/src/components/SyntaxTest/SyntaxTest.jsx');
    expect(existsSync(componentPath)).toBe(true);
    
    const content = readFileSync(componentPath, 'utf-8');
    
    // Basic syntax checks
    expect(content).toMatch(/import React/);
    expect(content).toMatch(/const SyntaxTest = /);
    expect(content).toMatch(/export default SyntaxTest/);
    
    // No template artifacts
    expect(content).not.toMatch(/<%-?/);
    expect(content).not.toMatch(/<%/);
  });
});
```

### Integration Testing
```javascript
describe('Template Integration', () => {
  test('works with real project structure', async () => {
    // Set up real project structure
    const projectPath = './integration-test-project';
    
    // Generate files
    const result = await unjucks.generate({
      generator: 'fullstack',
      template: 'app',
      name: 'MyApp',
      output: projectPath
    });
    
    // Verify project can build
    const { exec } = require('child_process');
    const buildResult = await new Promise((resolve) => {
      exec('npm run build', { cwd: projectPath }, (error, stdout, stderr) => {
        resolve({ error, stdout, stderr });
      });
    });
    
    expect(buildResult.error).toBeNull();
  });
});
```

### Performance Testing
```javascript
describe('Template Performance', () => {
  test('generates large projects efficiently', async () => {
    const startTime = Date.now();
    
    const result = await unjucks.generate({
      generator: 'enterprise',
      template: 'microservice',
      name: 'LargeService',
      variables: {
        includeTests: true,
        includeDocumentation: true,
        entityCount: 50
      }
    });
    
    const duration = Date.now() - startTime;
    
    expect(result.success).toBe(true);
    expect(duration).toBeLessThan(10000); // Should complete within 10 seconds
    expect(result.files.length).toBeGreaterThan(100); // Should generate many files
  });
});
```

## Contribution Guidelines

### Getting Started
1. **Fork Repository**: Fork the template repository
2. **Create Branch**: Create feature branch for your template
3. **Follow Conventions**: Follow naming and structure conventions
4. **Test Thoroughly**: Test your templates before submitting
5. **Document**: Provide comprehensive documentation

### Submission Process
1. **Create Pull Request**: Submit PR with clear description
2. **Code Review**: Participate in code review process  
3. **Testing**: Ensure all tests pass
4. **Documentation**: Update documentation as needed
5. **Merge**: Template merged after approval

### Template Quality Checklist
- [ ] Follows naming conventions
- [ ] Includes proper documentation
- [ ] Has comprehensive test coverage
- [ ] Generates syntactically correct code
- [ ] Handles edge cases gracefully
- [ ] Follows security best practices
- [ ] Compatible with target frameworks
- [ ] Includes helpful prompts and validation

### Code Standards
```javascript
// Use consistent code style
module.exports = {
  // Always include description
  description: 'Template description',
  
  // Use descriptive prompt names
  prompts: [
    {
      type: 'input',
      name: 'componentName', // Not just 'name'
      message: 'What is the component name?',
      validate: input => input.length > 0 || 'Component name is required'
    }
  ],
  
  // Include error handling
  hooks: {
    after: (context) => {
      try {
        console.log(`✅ Generated ${context.componentName} successfully`);
      } catch (error) {
        console.error(`❌ Post-generation error: ${error.message}`);
      }
    }
  }
};
```

### Documentation Standards
Every template must include:
- **Purpose**: What the template generates
- **Usage**: How to use the template
- **Options**: Available options and flags
- **Examples**: Working examples
- **Dependencies**: Required dependencies
- **Compatibility**: Supported versions/platforms

## Best Practices

### Template Design
1. **Single Responsibility**: Each template should have one clear purpose
2. **Composability**: Templates should work well together
3. **Configurability**: Provide options without overwhelming users
4. **Consistency**: Follow established patterns and conventions
5. **Quality**: Generate high-quality, production-ready code

### Code Generation
1. **Syntax Correctness**: Always generate syntactically valid code
2. **Best Practices**: Follow language/framework best practices
3. **Security**: Avoid generating vulnerable code patterns
4. **Performance**: Consider performance implications
5. **Maintainability**: Generate maintainable, readable code

### User Experience
1. **Clear Prompts**: Use descriptive, helpful prompts
2. **Validation**: Validate user inputs appropriately
3. **Feedback**: Provide clear success/error messages
4. **Documentation**: Include inline comments in generated code
5. **Defaults**: Provide sensible defaults for common use cases

### Maintenance
1. **Version Compatibility**: Test with different versions
2. **Updates**: Keep templates updated with latest practices
3. **Dependencies**: Minimize and update dependencies
4. **Backward Compatibility**: Consider impact of changes
5. **Migration**: Provide migration guides when needed

## Examples

### Example 1: REST API Generator
```javascript
// _templates/api/endpoint/index.js
module.exports = {
  description: 'Generate REST API endpoint with full CRUD operations',
  
  prompts: [
    {
      type: 'input',
      name: 'resource',
      message: 'Resource name (e.g., user, product):',
      validate: input => /^[a-z][a-zA-Z0-9]*$/.test(input) || 'Invalid resource name'
    },
    {
      type: 'multiselect',
      name: 'methods',
      message: 'HTTP methods to include:',
      choices: [
        { name: 'GET (list)', value: 'list' },
        { name: 'GET (single)', value: 'get' },
        { name: 'POST (create)', value: 'create' },
        { name: 'PUT (update)', value: 'update' },
        { name: 'DELETE (remove)', value: 'delete' }
      ],
      default: ['list', 'get', 'create', 'update', 'delete']
    },
    {
      type: 'confirm',
      name: 'includeValidation',
      message: 'Include request validation?',
      default: true
    }
  ]
};
```

### Example 2: Database Model Generator
```ejs
---
to: models/<%= Name %>.js
---
const { Model, DataTypes } = require('sequelize');
const sequelize = require('../database');

class <%= Name %> extends Model {
<% if (methods.includes('associations')) { -%>
  static associate(models) {
    // Define associations here
<% associations.forEach(assoc => { -%>
    <%= Name %>.<%= assoc.type %>(<%= assoc.model %><%= assoc.options ? `, ${JSON.stringify(assoc.options)}` : '' %>);
<% }); -%>
  }
<% } -%>

<% if (methods.includes('scopes')) { -%>
  static initScopes() {
    <%= Name %>.addScope('defaultScope', {
      attributes: { exclude: ['createdAt', 'updatedAt'] }
    });
<% scopes.forEach(scope => { -%>
    
    <%= Name %>.addScope('<%= scope.name %>', <%= JSON.stringify(scope.options, null, 2) %>);
<% }); -%>
  }
<% } -%>
}

<%= Name %>.init({
<% fields.forEach((field, index) => { -%>
  <%= field.name %>: {
    type: DataTypes.<%= field.type.toUpperCase() %>,
<% if (field.allowNull !== undefined) { -%>
    allowNull: <%= field.allowNull %>,
<% } -%>
<% if (field.unique) { -%>
    unique: true,
<% } -%>
<% if (field.defaultValue !== undefined) { -%>
    defaultValue: <%= typeof field.defaultValue === 'string' ? `'${field.defaultValue}'` : field.defaultValue %>,
<% } -%>
<% if (field.validate) { -%>
    validate: <%= JSON.stringify(field.validate, null, 2) %>,
<% } -%>
  }<%= index < fields.length - 1 ? ',' : '' %>
<% }); -%>
}, {
  sequelize,
  modelName: '<%= Name %>',
  tableName: '<%= name.toLowerCase() %>s',
<% if (includeTimestamps) { -%>
  timestamps: true,
<% } -%>
<% if (paranoid) { -%>
  paranoid: true,
<% } -%>
});

module.exports = <%= Name %>;
```

### Example 3: Full-Stack Component
```javascript
// _templates/fullstack/feature/index.js
module.exports = [
  {
    type: 'add',
    path: 'backend/models/{{Name}}.js',
    templateFile: 'fullstack/feature/model.ejs'
  },
  {
    type: 'add',
    path: 'backend/controllers/{{name}}Controller.js',
    templateFile: 'fullstack/feature/controller.ejs'
  },
  {
    type: 'add',
    path: 'backend/routes/{{name}}.js',
    templateFile: 'fullstack/feature/routes.ejs'
  },
  {
    type: 'add',
    path: 'frontend/src/components/{{Name}}/{{Name}}.jsx',
    templateFile: 'fullstack/feature/component.ejs'
  },
  {
    type: 'add',
    path: 'frontend/src/services/{{name}}Service.js',
    templateFile: 'fullstack/feature/service.ejs'
  },
  {
    type: 'add',
    path: 'frontend/src/hooks/use{{Name}}.js',
    templateFile: 'fullstack/feature/hook.ejs'
  }
];
```

---

This comprehensive guide provides everything needed to create, test, and contribute high-quality templates to the Unjucks ecosystem. For additional support, see the [API Documentation](API_DOCUMENTATION.md) and [User Guide](USER_GUIDE.md).