# KGEN Office Document Processing System\n\nComprehensive Office document template processing system for KGEN, supporting Word, Excel, and PowerPoint documents with variable replacement, content injection, and deterministic generation capabilities.\n\n## Features\n\n- **Multi-Format Support**: Word (.docx), Excel (.xlsx), PowerPoint (.pptx)\n- **Variable Replacement**: Nunjucks, Mustache, Handlebars, and simple syntax\n- **Content Injection**: Inject content at specific markers or bookmarks\n- **Template Validation**: Comprehensive validation of templates and data\n- **Batch Processing**: Process multiple templates concurrently\n- **Enterprise Features**: Logging, error handling, progress tracking\n- **Extensible Architecture**: Plugin system for custom processors\n\n## Quick Start\n\n```javascript\nimport { createOfficeProcessor } from '@kgen/office';\n\n// Create a processor\nconst processor = createOfficeProcessor({\n  syntax: 'nunjucks',\n  debug: true\n});\n\n// Process a template\nconst result = await processor.process(\n  './templates/report.docx',\n  { userName: 'John Doe', date: new Date() },\n  './output/report.docx'\n);\n\nif (result.success) {\n  console.log('Template processed successfully!');\n}\n```\n\n## Architecture\n\n### Core Components\n\n- **OfficeTemplateProcessor**: Main processor orchestrating document processing\n- **BaseOfficeProcessor**: Abstract base class for document processors\n- **DocumentProcessors**: Word, Excel, and PowerPoint specific processors\n- **VariableExtractor**: Extracts and analyzes template variables\n- **ValidationEngine**: Validates templates and data\n- **OfficeInjector**: Content injection system\n\n### Directory Structure\n\n```\nsrc/office/\n├── core/                    # Core types and base classes\n│   ├── types.js            # Type definitions and constants\n│   └── base-processor.js   # Abstract base processor\n├── processors/             # Document-specific processors\n│   ├── word-processor.js   # Word document processing\n│   ├── excel-processor.js  # Excel document processing\n│   └── powerpoint-processor.js # PowerPoint processing\n├── injectors/              # Content injection system\n│   ├── office-injector.js  # Main injection orchestrator\n│   ├── word-injector.js    # Word-specific injection\n│   ├── excel-injector.js   # Excel-specific injection\n│   └── powerpoint-injector.js # PowerPoint injection\n├── utils/                  # Utility modules\n│   ├── variable-extractor.js # Variable extraction\n│   ├── validation-engine.js  # Data validation\n│   ├── logger.js           # Logging system\n│   ├── injection-validator.js # Injection validation\n│   └── file-format-detector.js # Format detection\n├── index.js                # Main entry point\n├── office-template-processor.js # Main processor class\n└── README.md              # This file\n```\n\n## Usage Examples\n\n### Basic Template Processing\n\n```javascript\nimport { OfficeTemplateProcessor } from '@kgen/office';\n\nconst processor = new OfficeTemplateProcessor({\n  syntax: 'nunjucks',\n  validation: {\n    enabled: true,\n    failFast: false\n  }\n});\n\nconst result = await processor.process(\n  './templates/invoice.docx',\n  {\n    customerName: 'Acme Corp',\n    invoiceNumber: 'INV-001',\n    date: '2024-01-15',\n    items: [\n      { name: 'Product A', quantity: 2, price: 50.00 },\n      { name: 'Product B', quantity: 1, price: 75.00 }\n    ]\n  },\n  './output/invoice-001.docx'\n);\n```\n\n### Content Injection\n\n```javascript\nimport { OfficeInjector } from '@kgen/office';\n\nconst injector = new OfficeInjector({\n  preserveFormatting: true,\n  validateInputs: true\n});\n\nconst result = await injector.injectFile({\n  filePath: './templates/contract.docx',\n  injections: [\n    {\n      target: 'bookmark:client_name',\n      content: 'Acme Corporation',\n      mode: 'replace',\n      type: 'text'\n    },\n    {\n      target: 'bookmark:terms',\n      content: 'Net 30 payment terms apply...',\n      mode: 'replace',\n      type: 'text'\n    }\n  ],\n  outputPath: './output/contract-acme.docx'\n});\n```\n\n### Batch Processing\n\n```javascript\nconst batchConfig = {\n  templates: [\n    { templatePath: './templates/report1.docx', outputPath: './output/report1.docx' },\n    { templatePath: './templates/report2.xlsx', outputPath: './output/report2.xlsx' }\n  ],\n  data: [\n    { title: 'Q1 Report', data: q1Data },\n    { title: 'Q1 Financials', data: q1Financials }\n  ],\n  parallel: true,\n  maxConcurrency: 3\n};\n\nconst results = await processor.batchProcess(batchConfig);\nconsole.log(`Processed ${results.completed} of ${results.total} templates`);\n```\n\n### Variable Extraction\n\n```javascript\nimport { extractTemplateVariables } from '@kgen/office';\n\nconst variables = await extractTemplateVariables('./templates/form.docx');\nconsole.log('Template variables:', variables);\n// [\n//   { name: 'userName', type: 'string', required: true },\n//   { name: 'date', type: 'date', required: false },\n//   ...\n// ]\n```\n\n### Data Validation\n\n```javascript\nimport { validateTemplateData } from '@kgen/office';\n\nconst validationResult = await validateTemplateData(\n  { userName: 'John', age: 30 },\n  './templates/form.docx'\n);\n\nif (!validationResult.valid) {\n  console.error('Validation errors:', validationResult.errors);\n}\n```\n\n## Configuration\n\n### Processing Options\n\n```javascript\nconst options = {\n  // Variable syntax\n  syntax: 'nunjucks', // 'nunjucks' | 'mustache' | 'handlebars' | 'simple'\n  \n  // Processing mode\n  mode: 'replace', // 'replace' | 'inject' | 'append' | 'prepend' | 'merge'\n  \n  // Debug and development\n  debug: false,\n  dryRun: false,\n  force: false,\n  \n  // Validation\n  validation: {\n    enabled: true,\n    failFast: false,\n    level: 'moderate' // 'strict' | 'moderate' | 'lenient'\n  },\n  \n  // Output configuration\n  output: {\n    preserveFormatting: true,\n    extension: null, // Auto-detect\n    directory: null,\n    naming: '{name}_processed.{ext}'\n  }\n};\n```\n\n### Injection Options\n\n```javascript\nconst injectionOptions = {\n  preserveFormatting: true,\n  validateInputs: true,\n  dryRun: false,\n  force: false\n};\n```\n\n## Template Frontmatter\n\nTemplates can include frontmatter metadata for enhanced processing:\n\n```yaml\n---\nname: Invoice Template\ndescription: Standard invoice template\ntype: word\nsyntax: nunjucks\nvariables:\n  - name: customerName\n    type: string\n    required: true\n    description: Customer company name\n  - name: invoiceNumber\n    type: string\n    required: true\n    pattern: \"^INV-\\\\d{3}$\"\n  - name: items\n    type: array\n    required: true\n    description: Invoice line items\ninjectionPoints:\n  - id: signature\n    marker: \"[[SIGNATURE]]\"\n    type: image\n    required: false\n---\n```\n\n## Error Handling\n\nThe system provides comprehensive error handling with different severity levels:\n\n```javascript\ntry {\n  const result = await processor.process(templatePath, data, outputPath);\n  \n  if (!result.success) {\n    console.error('Processing failed:', result.validation.errors);\n    \n    // Handle different error types\n    result.validation.errors.forEach(error => {\n      switch (error.code) {\n        case 'MISSING_REQUIRED_VARIABLE':\n          console.log(`Missing required variable: ${error.field}`);\n          break;\n        case 'INVALID_VARIABLE_TYPE':\n          console.log(`Invalid type for variable: ${error.field}`);\n          break;\n        // ... handle other error codes\n      }\n    });\n  }\n} catch (error) {\n  console.error('Unexpected error:', error.message);\n}\n```\n\n## Extending the System\n\n### Custom Document Processor\n\n```javascript\nimport { BaseOfficeProcessor } from '@kgen/office';\n\nclass CustomProcessor extends BaseOfficeProcessor {\n  getSupportedType() {\n    return 'custom';\n  }\n  \n  getSupportedExtensions() {\n    return ['.custom'];\n  }\n  \n  async processTemplate(template, data, frontmatter) {\n    // Custom processing logic\n  }\n}\n\n// Register the custom processor\nprocessor.registerProcessor('custom', new CustomProcessor());\n```\n\n### Custom Validation\n\n```javascript\nconst customValidator = {\n  name: 'businessEmail',\n  description: 'Validates business email addresses',\n  fn: async (data) => {\n    const errors = [];\n    const warnings = [];\n    \n    if (data.email && !data.email.includes('@company.com')) {\n      errors.push({\n        message: 'Email must be a company email address',\n        code: 'INVALID_BUSINESS_EMAIL',\n        field: 'email'\n      });\n    }\n    \n    return { valid: errors.length === 0, errors, warnings };\n  }\n};\n\n// Register custom validator\nprocessor.validationEngine.registerValidator(customValidator);\n```\n\n## Performance Considerations\n\n- **Batch Processing**: Use batch processing for multiple templates\n- **Concurrency**: Limit concurrent operations based on system resources\n- **Memory Management**: Large documents may require streaming processing\n- **Caching**: Template parsing results are cached for repeated use\n- **File Size Limits**: Configure appropriate limits for document sizes\n\n## Security\n\n- **Input Validation**: All input data is validated before processing\n- **Path Traversal Protection**: File paths are sanitized\n- **Content Sanitization**: Dangerous content patterns are detected\n- **Access Controls**: File system access is controlled and logged\n\n## Testing\n\n```bash\n# Run all tests\nnpm test\n\n# Run Office-specific tests\nnpm test tests/office\n\n# Run with coverage\nnpm run test:coverage\n```\n\n## Contributing\n\n1. Follow the established architecture patterns\n2. Add comprehensive JSDoc documentation\n3. Include unit tests for new functionality\n4. Update this README for new features\n5. Follow the existing code style and conventions\n\n## License\n\nThis module is part of the KGEN project and follows the same licensing terms."