/**
 * CLI Renderer Integration Test
 * 
 * Verifies that the CLI uses ONLY the single DeterministicRenderer entry point
 * and produces consistent, canonical output
 */

import { exec } from 'child_process';
import { promisify } from 'util';
import { writeFileSync, readFileSync, mkdirSync, existsSync } from 'fs';
import { resolve } from 'path';
import { createHash } from 'crypto';

const execAsync = promisify(exec);
const OUTPUT_DIR = './tests/cli-output';

// Ensure output directory exists
if (!existsSync(OUTPUT_DIR)) {
  mkdirSync(OUTPUT_DIR, { recursive: true });
}

/**
 * Test CLI deterministic render command
 */
async function testCLIRenderCommand() {
  console.log('ðŸ§ª Testing CLI deterministic render command...\n');

  // Create test template
  const testTemplate = `---
to: "test-output-{{title}}.txt"
---
# {{title}}

Author: {{author}}
Timestamp: {{timestamp}}

Content:
{{content}}

Items:
{% for item in items %}
- {{item}}
{% endfor %}

Generated by: KGEN CLI`;

  const templatePath = resolve(OUTPUT_DIR, 'test-template.njk');
  writeFileSync(templatePath, testTemplate);

  // Create test data
  const testData = {
    title: 'CLI Test',
    author: 'KGEN',
    timestamp: '2024-01-01T00:00:00.000Z',
    content: 'Testing CLI deterministic rendering',
    items: ['First', 'Second', 'Third']
  };

  const dataPath = resolve(OUTPUT_DIR, 'test-data.json');
  writeFileSync(dataPath, JSON.stringify(testData, null, 2));

  const results = [];

  try {
    console.log('ðŸ” Running CLI render command (first time)...');
    
    // First CLI run
    const result1 = await execAsync(
      `node dist/cli-entry.js deterministic render --template "${templatePath}" --data "${dataPath}" --format json --verify-deterministic --hash-output`,
      { cwd: process.cwd() }
    );
    
    const output1 = JSON.parse(result1.stdout);
    
    if (!output1.success) {
      throw new Error(`CLI render failed: ${output1.error?.message}`);
    }

    console.log(`âœ… First run: ${output1.data.size} bytes, hash: ${output1.data.contentHash.substring(0, 16)}...`);

    // Second CLI run
    console.log('ðŸ” Running CLI render command (second time)...');
    
    const result2 = await execAsync(
      `node dist/cli-entry.js deterministic render --template "${templatePath}" --data "${dataPath}" --format json --verify-deterministic --hash-output`,
      { cwd: process.cwd() }
    );
    
    const output2 = JSON.parse(result2.stdout);
    
    if (!output2.success) {
      throw new Error(`CLI render failed: ${output2.error?.message}`);
    }

    console.log(`âœ… Second run: ${output2.data.size} bytes, hash: ${output2.data.contentHash.substring(0, 16)}...`);

    // Compare results
    const isDeterministic = output1.data.contentHash === output2.data.contentHash;
    const sameSize = output1.data.size === output2.data.size;

    results.push({
      test: 'CLI Deterministic Render',
      deterministic: isDeterministic,
      sameSize,
      hash1: output1.data.contentHash,
      hash2: output2.data.contentHash,
      size1: output1.data.size,
      size2: output2.data.size,
      verified: output1.data.deterministic && output2.data.deterministic
    });

    if (isDeterministic && sameSize) {
      console.log('âœ… CLI Deterministic Render: PASSED');
    } else {
      console.log('âŒ CLI Deterministic Render: FAILED');
      if (!isDeterministic) console.log('   Hash mismatch!');
      if (!sameSize) console.log('   Size mismatch!');
    }

  } catch (error) {
    console.log(`âŒ CLI Deterministic Render: ERROR - ${error.message}`);
    results.push({
      test: 'CLI Deterministic Render',
      deterministic: false,
      error: error.message
    });
  }

  return results;
}

/**
 * Test CLI help and version commands
 */
async function testCLIBasicCommands() {
  console.log('\nðŸ§ª Testing CLI basic commands...\n');

  const results = [];

  try {
    // Test version command
    console.log('ðŸ” Testing --version command...');
    const versionResult = await execAsync('node dist/cli-entry.js --version', { cwd: process.cwd() });
    
    if (versionResult.stdout.trim()) {
      console.log(`âœ… Version: ${versionResult.stdout.trim()}`);
      results.push({ test: 'CLI Version', passed: true, output: versionResult.stdout.trim() });
    } else {
      console.log('âŒ Version: No output');
      results.push({ test: 'CLI Version', passed: false });
    }

    // Test help command
    console.log('ðŸ” Testing --help command...');
    const helpResult = await execAsync('node dist/cli-entry.js --help', { cwd: process.cwd() });
    
    if (helpResult.stdout.includes('deterministic') || helpResult.stdout.includes('render')) {
      console.log('âœ… Help: Contains expected commands');
      results.push({ test: 'CLI Help', passed: true });
    } else {
      console.log('âŒ Help: Missing expected commands');
      results.push({ test: 'CLI Help', passed: false });
    }

  } catch (error) {
    console.log(`âŒ CLI Basic Commands: ERROR - ${error.message}`);
    results.push({
      test: 'CLI Basic Commands',
      passed: false,
      error: error.message
    });
  }

  return results;
}

/**
 * Test that CLI imports are correct
 */
async function testCLIImports() {
  console.log('\nðŸ§ª Testing CLI import structure...\n');

  try {
    // Check the CLI entry file for proper imports
    const cliEntryPath = resolve(process.cwd(), 'dist/cli-entry.js');
    
    if (!existsSync(cliEntryPath)) {
      throw new Error('CLI entry file not found at dist/cli-entry.js');
    }

    const cliContent = readFileSync(cliEntryPath, 'utf8');
    
    // Check for single renderer import
    const hasCorrectRendererImport = cliContent.includes('DeterministicRenderer') ||
                                   cliContent.includes('kgen-templates');
    
    // Check that it doesn't import multiple renderers
    const hasMultipleRenderers = cliContent.includes('TemplateRenderer') && 
                               cliContent.includes('DeterministicRenderer');

    const results = [];

    if (hasCorrectRendererImport) {
      console.log('âœ… CLI uses single renderer import');
      results.push({ test: 'Single Renderer Import', passed: true });
    } else {
      console.log('âŒ CLI missing correct renderer import');
      results.push({ test: 'Single Renderer Import', passed: false });
    }

    if (!hasMultipleRenderers) {
      console.log('âœ… CLI does not import multiple renderers');
      results.push({ test: 'No Multiple Renderers', passed: true });
    } else {
      console.log('âŒ CLI imports multiple renderers');
      results.push({ test: 'No Multiple Renderers', passed: false });
    }

    return results;

  } catch (error) {
    console.log(`âŒ CLI Imports Test: ERROR - ${error.message}`);
    return [{ test: 'CLI Imports', passed: false, error: error.message }];
  }
}

/**
 * Main test runner
 */
async function runCLITests() {
  const startTime = Date.now();
  
  console.log('ðŸš€ CLI Renderer Integration Test Suite\n');
  console.log('Verifying CLI uses ONLY single DeterministicRenderer...\n');

  try {
    // Run all tests
    const renderResults = await testCLIRenderCommand();
    const basicResults = await testCLIBasicCommands();
    const importResults = await testCLIImports();

    const allResults = [...renderResults, ...basicResults, ...importResults];

    // Summary
    console.log('\nðŸ“Š CLI Test Summary:');
    console.log('====================');

    const passedTests = allResults.filter(r => r.passed || r.deterministic).length;
    const totalTests = allResults.length;
    
    console.log(`Tests Passed: ${passedTests}/${totalTests}`);

    const allPassed = passedTests === totalTests;

    console.log(`\nOverall Result: ${allPassed ? 'âœ… ALL CLI TESTS PASSED' : 'âŒ SOME CLI TESTS FAILED'}`);
    console.log(`Test Duration: ${Date.now() - startTime}ms`);

    // Output detailed results
    console.log('\nðŸ“ Detailed CLI Results:');
    console.log('=========================');
    
    allResults.forEach(result => {
      const status = result.passed || result.deterministic ? 'âœ…' : 'âŒ';
      console.log(`${result.test}: ${status}`);
      if (result.error) console.log(`  Error: ${result.error}`);
      if (result.hash1 && result.hash2) {
        console.log(`  Hash consistency: ${result.hash1 === result.hash2 ? 'YES' : 'NO'}`);
      }
    });

    return {
      success: allPassed,
      results: allResults
    };

  } catch (error) {
    console.error('âŒ CLI test suite failed:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

// Run tests if this file is executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  runCLITests().then(result => {
    process.exit(result.success ? 0 : 1);
  });
}

export { runCLITests, testCLIRenderCommand, testCLIBasicCommands, testCLIImports };