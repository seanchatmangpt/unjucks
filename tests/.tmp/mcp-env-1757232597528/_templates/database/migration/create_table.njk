---
to: "{{ dest }}/{{ timestamp }}_create_{{ tableName }}_table.sql"
---
-- Create {{ tableName }} table
CREATE TABLE {{ tableName }} (
  id BIGSERIAL PRIMARY KEY,
  {% for column in columns -%}
  {{ column.name }} {{ column.type }}{% if column.nullable === false %} NOT NULL{% endif %}{% if column.default %} DEFAULT {{ column.default }}{% endif %},
  {% endfor -%}
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- Create indexes
{% for index in indexes -%}
CREATE INDEX idx_{{ tableName }}_{{ index.columns | join('_') }} ON {{ tableName }}({{ index.columns | join(', ') }});
{% endfor %}

-- Create updated_at trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_{{ tableName }}_updated_at 
  BEFORE UPDATE ON {{ tableName }} 
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();