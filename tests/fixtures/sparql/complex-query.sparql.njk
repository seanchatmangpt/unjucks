---
to: "{{ dest }}/queries/complex-{{ queryName }}.sparql"
inject: false
---
PREFIX ex: <{{ baseUri }}/>
PREFIX schema: <http://schema.org/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX dbo: <http://dbpedia.org/ontology/>

SELECT {% for var in variables %}{{ var | sparqlVar }}{% if not loop.last %} {% endif %}{% endfor %}{% if aggregations and variables %} {% endif %}{% if aggregations %}{% for agg in aggregations %}{{ agg | sparqlAggregation }}{% if not loop.last %} {% endif %}{% endfor %}{% endif %}
WHERE {
  {% if namedGraphs %}
  {% for graph in namedGraphs %}
  GRAPH {{ graph | rdfResource }} {
    {% for pattern in graph.patterns %}
    {{ pattern.subject | sparqlVar }} {{ pattern.predicate | rdfPropertyFilter }} {{ pattern.object | sparqlValue }} .
    {% endfor %}
  }
  {% endfor %}
  {% endif %}
  
  {% for pattern in patterns %}
  {{ pattern.subject | sparqlVar }} {% if pattern.propertyPath %}{{ pattern.propertyPath | sparqlPropertyPath }}{% else %}{{ pattern.predicate | rdfPropertyFilter }}{% endif %} {{ pattern.object | sparqlValue }} .
  {% endfor %}
  
  {% if regexFilters %}
  {% for regex in regexFilters %}
  FILTER(regex({{ regex.variable | sparqlVar }}, "{{ regex.pattern | escapeRegex }}"{% if regex.flags %}, "{{ regex.flags }}"{% endif %}))
  {% endfor %}
  {% endif %}
  
  {% if languageFilters %}
  {% for langFilter in languageFilters %}
  FILTER(lang({{ langFilter.variable | sparqlVar }}) = "{{ langFilter.language }}")
  {% endfor %}
  {% endif %}
  
  {% if datatypeFilters %}
  {% for dtFilter in datatypeFilters %}
  FILTER(datatype({{ dtFilter.variable | sparqlVar }}) = {{ dtFilter.datatype | rdfDatatype }})
  {% endfor %}
  {% endif %}
  
  {% if boundFilters %}
  {% for bound in boundFilters %}
  FILTER({% if bound.negated %}!{% endif %}bound({{ bound.variable | sparqlVar }}))
  {% endfor %}
  {% endif %}
  
  {% if existsPatterns %}
  {% for exists in existsPatterns %}
  FILTER({% if exists.negated %}NOT {% endif %}EXISTS {
    {% for pattern in exists.patterns %}
    {{ pattern.subject | sparqlVar }} {{ pattern.predicate | rdfPropertyFilter }} {{ pattern.object | sparqlValue }} .
    {% endfor %}
  })
  {% endfor %}
  {% endif %}
  
  {% if serviceQueries %}
  {% for service in serviceQueries %}
  SERVICE {% if service.silent %}SILENT {% endif %}{{ service.endpoint | rdfResource }} {
    {% for pattern in service.patterns %}
    {{ pattern.subject | sparqlVar }} {{ pattern.predicate | rdfPropertyFilter }} {{ pattern.object | sparqlValue }} .
    {% endfor %}
  }
  {% endfor %}
  {% endif %}
}
{% if groupBy %}GROUP BY {% for var in groupBy %}{{ var | sparqlVar }}{% if not loop.last %} {% endif %}{% endfor %}{% endif %}
{% if havingConditions %}HAVING {{ havingConditions | map('sparqlFilter') | join(' && ') }}{% endif %}
{% if orderBy %}ORDER BY {% for order in orderBy %}{{ order | sparqlOrderBy }}{% if not loop.last %} {% endif %}{% endfor %}{% endif %}
LIMIT {{ limit | default(100) }}