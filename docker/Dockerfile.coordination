# Coordination-enabled Docker image for swarm testing
FROM node:20-alpine

# Install Docker CLI and system tools for coordination
RUN apk add --no-cache \
    docker-cli \
    docker-compose \
    bash \
    curl \
    git \
    jq

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies including coordination tools
RUN npm ci --include=dev

# Install Claude Flow for coordination hooks
RUN npm install -g claude-flow@alpha

# Copy source code
COPY . .

# Create coordination directories
RUN mkdir -p \
    /app/coordination-logs \
    /app/coordination-reports \
    /app/swarm-metrics

# Copy coordination scripts
COPY docker/scripts/coordination-init.sh /usr/local/bin/
COPY docker/scripts/swarm-validator.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/*.sh

# Set coordination environment
ENV COORDINATION_ENABLED=true
ENV SWARM_ID="docker-validation"
ENV COORDINATION_NETWORK="unjucks-coord"

# Health check that includes coordination status
HEALTHCHECK --interval=30s --timeout=15s --start-period=10s --retries=3 \
    CMD coordination-init.sh --health-check || exit 1

# Default command initializes coordination
CMD ["coordination-init.sh"]